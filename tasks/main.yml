---

- name: Update all packages
  become: yes
  become_user: root
  yum:
    name: "*"
    state: latest
    update_cache: yes

- name: Copy Splunk SOAR to server
  become: yes
  become_user: root
  unarchive:
    src: "{{ ar_soar_apps_folder }}{{ ar_soar_file }}"
    dest: "/home/{{ ar_soar_setup_user }}"
    owner: "{{ ar_soar_setup_user }}"
    group: "{{ ar_soar_setup_user }}"

- name: Creates directory
  become: yes
  become_user: root
  file:
    path: /opt/soar
    state: directory
    owner: "{{ ar_soar_setup_user }}"
    group: "{{ ar_soar_setup_user }}"

- name: prepare phantom install script without apps
  become: yes
  command: "/home/{{ ar_soar_setup_user }}/splunk-soar/soar-prepare-system --splunk-soar-home /opt/soar --no-prompt" 
  # Note: soar-prepare-system creates a user named 'phantom' (hardcoded)

- name: copy splunk soar folder
  become: yes
  become_user: root
  command: "cp -r /home/{{ ar_soar_setup_user }}/splunk-soar /home/phantom/splunk-soar"

- name: chown splunk soar folder
  become: yes
  become_user: root
  command: "chown -R phantom:phantom /home/phantom/splunk-soar"

- name: Change ownership of /opt/soar to phantom user
  become: yes
  become_user: root
  file:
    path: /opt/soar
    owner: phantom
    group: phantom
    recurse: yes
    state: directory

- name: run the phantom install script 
  become: yes
  become_user: root
  shell: |
    su - phantom -c "cd /home/phantom/splunk-soar && ./soar-install --splunk-soar-home /opt/soar --no-prompt --ignore-warnings"
  async: 3600
  poll: 30
  register: soar_install_result

- name: Display SOAR installation output
  debug:
    msg: "{{ soar_install_result.stdout_lines }}"
  when: soar_install_result.stdout_lines is defined

- name: Verify SOAR installation completed successfully
  fail:
    msg: "SOAR installation failed with return code {{ soar_install_result.rc }}. Output: {{ soar_install_result.stderr_lines | default([]) }}"
  when: soar_install_result.rc is defined and soar_install_result.rc != 0

- name: change phantom admin password
  uri:
    url: https://127.0.0.1:8443/rest/user_settings
    method: POST
    user: soar_local_admin
    password: password
    body: {"old_password":"password","password":"{{ar_soar_password}}"}
    body_format: json
    force_basic_auth: yes
    validate_certs: no

- name: open up api allowed ip list
  uri:
    url: https://127.0.0.1:8443/rest/ph_user/2
    method: POST
    body: '{"allowed_ips":["any"]}'
    user: soar_local_admin
    password: "{{ar_soar_password}}"
    force_basic_auth: yes
    validate_certs: no